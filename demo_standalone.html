<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ReliefWeb Document Fetcher & PDF Processor</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem 0;
        }

        .demo-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
        }

        .demo-header {
            text-align: center;
            color: white;
            margin-bottom: 2rem;
        }

        .demo-header h1 {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .demo-header p { font-size: 1.15rem; opacity: 0.95; }

        /* Info banner */
        .info-banner {
            background: linear-gradient(135deg, #fff7ed, #fffbeb);
            border: 2px solid #f59e0b;
            border-radius: 12px;
            padding: 1.5rem 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .info-banner h3 {
            color: #92400e;
            font-size: 1.1rem;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .info-banner p {
            color: #78350f;
            font-size: 0.95rem;
            line-height: 1.6;
        }

        .info-banner a {
            color: #2563eb;
            font-weight: 600;
            text-decoration: none;
        }

        .info-banner a:hover { text-decoration: underline; }

        .info-banner .steps {
            margin-top: 0.75rem;
            padding-left: 0;
            list-style: none;
        }

        .info-banner .steps li {
            padding: 0.3rem 0;
            padding-left: 1.8rem;
            position: relative;
            color: #78350f;
            font-size: 0.9rem;
        }

        .info-banner .steps li .step-num {
            position: absolute;
            left: 0;
            background: #f59e0b;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 700;
            top: 4px;
        }

        /* Server status */
        .status-bar {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .status-online { background: #d1fae5; color: #065f46; }
        .status-offline { background: #fee2e2; color: #991b1b; }

        .status-dot {
            width: 8px; height: 8px; border-radius: 50%;
        }

        .status-online .status-dot { background: #10b981; }
        .status-offline .status-dot { background: #ef4444; }

        /* Cards */
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .card-header {
            text-align: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #e2e8f0;
        }

        .card-header h2 {
            color: #2c5aa0;
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .card-header p { color: #64748b; font-size: 0.9rem; }

        /* Forms */
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
            margin-bottom: 1.25rem;
        }

        .form-label {
            font-weight: 600;
            color: #1e293b;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .form-input, .form-select {
            padding: 0.7rem 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.2s;
            background: white;
            color: #1e293b;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #2c5aa0;
            box-shadow: 0 0 0 3px rgba(44,90,160,0.1);
        }

        /* Buttons */
        .btn {
            padding: 0.85rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .btn:hover:not(:disabled) { transform: translateY(-2px); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn-primary { background: #2c5aa0; color: white; }
        .btn-primary:hover:not(:disabled) { background: #234a85; box-shadow: 0 4px 12px rgba(44,90,160,0.3); }

        .btn-secondary { background: #e8734e; color: white; }
        .btn-secondary:hover:not(:disabled) { background: #d46839; box-shadow: 0 4px 12px rgba(232,115,78,0.3); }

        .btn-success { background: #10b981; color: white; }
        .btn-success:hover:not(:disabled) { background: #059669; }

        .btn-full { width: 100%; }

        /* Progress */
        .progress-section { display: none; margin-top: 1.5rem; }
        .progress-section.active { display: block; }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .progress-status { font-weight: 600; color: #1e293b; font-size: 0.9rem; }
        .progress-percent { font-size: 1.5rem; font-weight: 700; color: #2c5aa0; }

        .progress-bar-bg {
            height: 12px;
            background: #f1f5f9;
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #2c5aa0, #e8734e);
            border-radius: 6px;
            transition: width 0.3s;
            width: 0%;
        }

        .progress-message { color: #64748b; font-size: 0.85rem; text-align: center; }

        /* Results */
        .results-section { display: none; margin-top: 1.5rem; }
        .results-section.active { display: block; }

        .results-header {
            background: linear-gradient(135deg, #2c5aa0, #e8734e);
            color: white;
            padding: 1.25rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .results-title { font-size: 1.25rem; font-weight: 700; margin-bottom: 0.75rem; }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 0.75rem;
        }

        .stat-box {
            background: rgba(255,255,255,0.2);
            padding: 0.75rem;
            border-radius: 6px;
            backdrop-filter: blur(10px);
        }

        .stat-value { font-size: 1.75rem; font-weight: 700; }
        .stat-label { font-size: 0.8rem; opacity: 0.9; }

        .actions { display: flex; gap: 0.75rem; flex-wrap: wrap; margin-top: 1rem; }

        /* Alert */
        .alert {
            padding: 0.85rem 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: none;
            font-size: 0.9rem;
        }

        .alert.active { display: block; }
        .alert-error { background: #fee2e2; border: 1px solid #ef4444; color: #991b1b; }
        .alert-success { background: #d1fae5; border: 1px solid #10b981; color: #065f46; }

        /* Upload area */
        .upload-area {
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: #f8fafc;
            position: relative;
        }

        .upload-area:hover { border-color: #2c5aa0; background: #f0f4ff; }
        .upload-area.dragover { border-color: #2c5aa0; background: #e0e7ff; }
        .upload-area.has-files { border-style: solid; border-color: #10b981; background: #f0fdf4; }

        .upload-area input[type="file"] {
            position: absolute;
            inset: 0;
            opacity: 0;
            cursor: pointer;
        }

        .upload-icon { font-size: 2.5rem; margin-bottom: 0.5rem; }
        .upload-title { font-weight: 600; color: #1e293b; margin-bottom: 0.25rem; }
        .upload-subtitle { color: #64748b; font-size: 0.85rem; }

        .file-list {
            margin-top: 1rem;
            text-align: left;
            max-height: 150px;
            overflow-y: auto;
        }

        .file-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.3rem 0;
            font-size: 0.85rem;
            color: #334155;
        }

        .file-item .file-icon { color: #ef4444; }

        /* Matching stats */
        .matching-stats {
            margin-top: 1rem;
            background: #f8fafc;
            border-radius: 8px;
            padding: 1rem;
        }

        .matching-stats h4 {
            font-size: 0.85rem;
            color: #64748b;
            text-transform: uppercase;
            margin-bottom: 0.5rem;
        }

        .matching-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.5rem;
        }

        .matching-item {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
            background: white;
            border-radius: 4px;
        }

        .matching-item .label { color: #64748b; }
        .matching-item .value { font-weight: 600; color: #1e293b; }

        /* Tabs */
        .tab-bar {
            display: flex;
            gap: 0;
            margin-bottom: 0;
        }

        .tab-btn {
            flex: 1;
            padding: 1rem;
            border: none;
            background: rgba(255,255,255,0.3);
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 12px 12px 0 0;
        }

        .tab-btn.active {
            background: white;
            color: #2c5aa0;
        }

        .tab-btn:not(.active):hover { background: rgba(255,255,255,0.5); }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        @media (max-width: 768px) {
            .demo-header h1 { font-size: 1.75rem; }
            .card { padding: 1.25rem; }
            .actions { flex-direction: column; }
            .btn { width: 100%; }
            .tab-btn { font-size: 0.85rem; padding: 0.75rem 0.5rem; }
        }
    </style>
</head>
<body>
    <div class="demo-container">
        <!-- Header -->
        <div class="demo-header">
            <h1>&#127758; ReliefWeb Tools</h1>
            <p>Fetch disaster reports & extract text from PDFs</p>
        </div>

        <!-- Info Banner -->
        <div class="info-banner">
            <h3>&#9888;&#65039; Before you start</h3>
            <p>
                First, check the disaster you are looking for on
                <a href="https://reliefweb.int/disasters" target="_blank">reliefweb.int/disasters</a>.
                Make sure the disaster name and country match what is listed on ReliefWeb.
            </p>
            <ol class="steps">
                <li><span class="step-num">1</span> Visit <a href="https://reliefweb.int/disasters" target="_blank">reliefweb.int/disasters</a> and find your disaster</li>
                <li><span class="step-num">2</span> Use <strong>Tab 1</strong> to fetch documents and download the ZIP</li>
                <li><span class="step-num">3</span> Unzip the file on your computer</li>
                <li><span class="step-num">4</span> Use <strong>Tab 2</strong> to upload the PDFs + JSON and extract full text</li>
            </ol>
        </div>

        <!-- Server Status -->
        <div class="status-bar">
            <div id="serverStatus" class="status-indicator status-offline">
                <span class="status-dot"></span>
                <span>Checking server...</span>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tab-bar">
            <button class="tab-btn active" onclick="switchTab('fetch')">&#128196; 1. Fetch Documents</button>
            <button class="tab-btn" onclick="switchTab('process')">&#128295; 2. Process PDFs</button>
        </div>

        <!-- TAB 1: Document Fetcher -->
        <div id="tab-fetch" class="tab-content active">
            <div class="card" style="border-radius: 0 0 12px 12px;">
                <div class="card-header">
                    <h2>&#128203; Document Fetcher</h2>
                    <p>Search and download disaster-related documents from ReliefWeb</p>
                </div>

                <div id="fetchAlert" class="alert"><span id="fetchAlertMsg"></span></div>

                <form id="fetchForm">
                    <div class="form-group">
                        <label class="form-label" for="disasterName">Disaster Name</label>
                        <input type="text" id="disasterName" class="form-input"
                               placeholder="e.g., Hurricane Melissa, Earthquake, Typhoon Haiyan"
                               value="Hurricane Melissa" required />
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="countrySelect">Country</label>
                        <select id="countrySelect" class="form-select" required>
                            <option value="">Select a country...</option>
                        </select>
                    </div>

                    <button type="submit" class="btn btn-primary btn-full">&#128640; Fetch Documents</button>
                </form>

                <div id="fetchProgress" class="progress-section">
                    <div class="progress-header">
                        <span class="progress-status" id="fetchProgressStatus">Initializing...</span>
                        <span class="progress-percent" id="fetchProgressPercent">0%</span>
                    </div>
                    <div class="progress-bar-bg">
                        <div class="progress-bar" id="fetchProgressBar"></div>
                    </div>
                    <p class="progress-message" id="fetchProgressMsg">Starting...</p>
                </div>

                <div id="fetchResults" class="results-section">
                    <div class="results-header">
                        <h3 class="results-title">&#9989; Download Complete!</h3>
                        <div class="stats-grid">
                            <div class="stat-box">
                                <div class="stat-value" id="fetchStatReports">0</div>
                                <div class="stat-label">Reports Found</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value" id="fetchStatPdfs">0</div>
                                <div class="stat-label">PDFs Downloaded</div>
                            </div>
                        </div>
                    </div>
                    <div class="actions">
                        <button class="btn btn-secondary" id="downloadZipBtn">&#128230; Download ZIP</button>
                        <button class="btn btn-primary" id="newFetchBtn">&#128260; New Search</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB 2: PDF Processor -->
        <div id="tab-process" class="tab-content">
            <div class="card" style="border-radius: 0 0 12px 12px;">
                <div class="card-header">
                    <h2>&#128295; PDF Text Processor</h2>
                    <p>Upload PDFs from your downloaded ZIP to extract full text</p>
                </div>

                <div id="processAlert" class="alert"><span id="processAlertMsg"></span></div>

                <!-- Upload PDFs -->
                <div class="form-group">
                    <label class="form-label">PDF Files</label>
                    <div class="upload-area" id="pdfUploadArea">
                        <input type="file" id="pdfFilesInput" multiple accept=".pdf" />
                        <div class="upload-icon">&#128196;</div>
                        <div class="upload-title">Click or drag PDF files here</div>
                        <div class="upload-subtitle">Select all PDFs from the /pdfs folder in your unzipped download</div>
                        <div class="file-list" id="pdfFileList"></div>
                    </div>
                </div>

                <!-- Upload metadata JSON -->
                <div class="form-group">
                    <label class="form-label">Metadata JSON (optional, recommended)</label>
                    <div class="upload-area" id="jsonUploadArea" style="padding: 1.25rem;">
                        <input type="file" id="jsonFileInput" accept=".json" />
                        <div class="upload-icon" style="font-size: 1.5rem;">&#128203;</div>
                        <div class="upload-title" style="font-size: 0.9rem;">Click to select the _reports.json file</div>
                        <div class="upload-subtitle">This enables matching PDFs with report metadata (title, source, date...)</div>
                        <div id="jsonFileName" style="margin-top: 0.5rem; font-weight: 600; color: #065f46; display: none;"></div>
                    </div>
                </div>

                <button class="btn btn-success btn-full" id="processBtn" disabled>
                    &#9881;&#65039; Process PDFs &amp; Extract Text
                </button>

                <div id="processProgress" class="progress-section">
                    <div class="progress-header">
                        <span class="progress-status" id="processProgressStatus">Initializing...</span>
                        <span class="progress-percent" id="processProgressPercent">0%</span>
                    </div>
                    <div class="progress-bar-bg">
                        <div class="progress-bar" id="processProgressBar" style="background: linear-gradient(90deg, #10b981, #059669);"></div>
                    </div>
                    <p class="progress-message" id="processProgressMsg">Starting...</p>
                </div>

                <div id="processResults" class="results-section">
                    <div class="results-header" style="background: linear-gradient(135deg, #059669, #10b981);">
                        <h3 class="results-title">&#9989; Text Extraction Complete!</h3>
                        <div class="stats-grid">
                            <div class="stat-box">
                                <div class="stat-value" id="procStatArticles">0</div>
                                <div class="stat-label">Total Articles</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value" id="procStatWithPdf">0</div>
                                <div class="stat-label">With PDF Text</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value" id="procStatWithout">0</div>
                                <div class="stat-label">Without PDF</div>
                            </div>
                        </div>
                    </div>

                    <div id="matchingStats" class="matching-stats" style="display: none;">
                        <h4>Matching Statistics</h4>
                        <div class="matching-grid" id="matchingGrid"></div>
                    </div>

                    <div class="actions">
                        <button class="btn btn-success" id="downloadResultBtn">&#128229; Download Full-Text JSON</button>
                        <button class="btn btn-primary" id="newProcessBtn">&#128260; Process New Files</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    (function() {
        'use strict';

        // --- Configuration ---
        const API_BASE = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:5000/api'
            : window.location.origin + '/api';

        // --- Tab switching ---
        window.switchTab = function(tab) {
            document.querySelectorAll('.tab-btn').forEach((btn, i) => {
                btn.classList.toggle('active', (tab === 'fetch' && i === 0) || (tab === 'process' && i === 1));
            });
            document.getElementById('tab-fetch').classList.toggle('active', tab === 'fetch');
            document.getElementById('tab-process').classList.toggle('active', tab === 'process');
        };

        // --- Server status ---
        async function checkServer() {
            const el = document.getElementById('serverStatus');
            try {
                const r = await fetch(API_BASE + '/health', { signal: AbortSignal.timeout(5000) });
                if (r.ok) {
                    el.className = 'status-indicator status-online';
                    el.innerHTML = '<span class="status-dot"></span><span>Server Online</span>';
                } else throw new Error();
            } catch {
                el.className = 'status-indicator status-offline';
                el.innerHTML = '<span class="status-dot"></span><span>Server Offline &mdash; start Flask backend first</span>';
            }
        }
        checkServer();

        // ============================================================
        // TAB 1: DOCUMENT FETCHER
        // ============================================================
        let fetchJobId = null;

        async function loadCountries() {
            try {
                const r = await fetch(API_BASE + '/countries');
                const countries = await r.json();
                const sel = document.getElementById('countrySelect');
                countries.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = JSON.stringify(c);
                    opt.textContent = c.name;
                    if (c.code === 'HTI') opt.selected = true;
                    sel.appendChild(opt);
                });
            } catch (e) {
                showAlert('fetch', 'Failed to load countries. Is the server running?', 'error');
            }
        }
        loadCountries();

        document.getElementById('fetchForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const name = document.getElementById('disasterName').value.trim();
            const countryVal = document.getElementById('countrySelect').value;
            if (!name || !countryVal) return showAlert('fetch', 'Please fill all fields', 'error');
            const country = JSON.parse(countryVal);

            hideAlert('fetch');
            hide('fetchResults');
            show('fetchProgress');
            updateProgress('fetch', 0, 'Initializing...', 'Connecting to ReliefWeb API...');

            try {
                const r = await fetch(API_BASE + '/fetch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        disaster_name: name,
                        country_code: country.code,
                        country_name: country.name
                    })
                });
                const data = await r.json();
                fetchJobId = data.job_id;
                pollFetchStatus();
            } catch (err) {
                showAlert('fetch', 'Error: ' + err.message, 'error');
                hide('fetchProgress');
            }
        });

        async function pollFetchStatus() {
            if (!fetchJobId) return;
            try {
                const r = await fetch(API_BASE + '/status/' + fetchJobId);
                const s = await r.json();
                updateProgress('fetch', s.progress || 0, s.status || 'Processing...', s.message || '');

                if (s.status === 'completed') {
                    hide('fetchProgress');
                    show('fetchResults');
                    document.getElementById('fetchStatReports').textContent = s.total_reports || 0;
                    document.getElementById('fetchStatPdfs').textContent = s.downloaded_pdfs || 0;
                    showAlert('fetch', 'Successfully downloaded ' + (s.downloaded_pdfs||0) + ' PDFs!', 'success');
                } else if (s.status === 'error') {
                    showAlert('fetch', s.message, 'error');
                    hide('fetchProgress');
                } else {
                    setTimeout(pollFetchStatus, 1000);
                }
            } catch (err) {
                showAlert('fetch', 'Polling error: ' + err.message, 'error');
                hide('fetchProgress');
            }
        }

        document.getElementById('downloadZipBtn').addEventListener('click', () => {
            if (fetchJobId) window.open(API_BASE + '/download/zip/' + fetchJobId, '_blank');
        });

        document.getElementById('newFetchBtn').addEventListener('click', () => {
            hide('fetchResults'); hide('fetchProgress'); hideAlert('fetch');
            fetchJobId = null;
        });

        // ============================================================
        // TAB 2: PDF PROCESSOR
        // ============================================================
        let uploadedPdfs = [];
        let uploadedJson = null;
        let processJobId = null;

        const pdfInput = document.getElementById('pdfFilesInput');
        const jsonInput = document.getElementById('jsonFileInput');
        const processBtn = document.getElementById('processBtn');

        // PDF file selection
        pdfInput.addEventListener('change', function() {
            uploadedPdfs = Array.from(this.files).filter(f => f.name.toLowerCase().endsWith('.pdf'));
            const area = document.getElementById('pdfUploadArea');
            const list = document.getElementById('pdfFileList');

            if (uploadedPdfs.length > 0) {
                area.classList.add('has-files');
                list.innerHTML = uploadedPdfs.map(f =>
                    '<div class="file-item"><span class="file-icon">&#128196;</span>' + f.name + ' <span style="color:#94a3b8;">(' + formatSize(f.size) + ')</span></div>'
                ).join('');
                processBtn.disabled = false;
            } else {
                area.classList.remove('has-files');
                list.innerHTML = '';
                processBtn.disabled = true;
            }
        });

        // Drag & drop for PDFs
        const pdfArea = document.getElementById('pdfUploadArea');
        pdfArea.addEventListener('dragover', e => { e.preventDefault(); pdfArea.classList.add('dragover'); });
        pdfArea.addEventListener('dragleave', () => pdfArea.classList.remove('dragover'));
        pdfArea.addEventListener('drop', e => {
            e.preventDefault();
            pdfArea.classList.remove('dragover');
            pdfInput.files = e.dataTransfer.files;
            pdfInput.dispatchEvent(new Event('change'));
        });

        // JSON file selection
        jsonInput.addEventListener('change', function() {
            if (this.files.length > 0) {
                uploadedJson = this.files[0];
                document.getElementById('jsonUploadArea').classList.add('has-files');
                const nameEl = document.getElementById('jsonFileName');
                nameEl.textContent = '&#9989; ' + uploadedJson.name;
                nameEl.style.display = 'block';
            }
        });

        // Process button
        processBtn.addEventListener('click', async function() {
            if (uploadedPdfs.length === 0) return showAlert('process', 'Please select PDF files first', 'error');

            hideAlert('process');
            hide('processResults');
            show('processProgress');
            updateProgress('process', 0, 'Uploading files...', 'Sending PDFs to server...');
            processBtn.disabled = true;

            const formData = new FormData();
            uploadedPdfs.forEach(f => formData.append('pdfs', f));
            if (uploadedJson) formData.append('metadata_json', uploadedJson);

            try {
                const r = await fetch(API_BASE + '/process', { method: 'POST', body: formData });
                if (!r.ok) {
                    const err = await r.json();
                    throw new Error(err.error || 'Upload failed');
                }
                const data = await r.json();
                processJobId = data.job_id;
                updateProgress('process', 5, 'Processing...', 'Files uploaded, extracting text...');
                pollProcessStatus();
            } catch (err) {
                showAlert('process', 'Error: ' + err.message, 'error');
                hide('processProgress');
                processBtn.disabled = false;
            }
        });

        async function pollProcessStatus() {
            if (!processJobId) return;
            try {
                const r = await fetch(API_BASE + '/process/status/' + processJobId);
                const s = await r.json();
                updateProgress('process', s.progress || 0, s.status || 'Processing...', s.message || '');

                if (s.status === 'completed') {
                    hide('processProgress');
                    show('processResults');
                    document.getElementById('procStatArticles').textContent = s.total_articles || 0;
                    document.getElementById('procStatWithPdf').textContent = s.articles_with_pdf || 0;
                    document.getElementById('procStatWithout').textContent = s.articles_without_pdf || 0;

                    // Show matching stats
                    if (s.matching_statistics) {
                        const grid = document.getElementById('matchingGrid');
                        grid.innerHTML = '';
                        const labels = {
                            exact_match: 'Exact Match',
                            reliefweb_id_match: 'ID Match',
                            title_match: 'Title Match',
                            no_match: 'No Match'
                        };
                        for (const [key, label] of Object.entries(labels)) {
                            if (s.matching_statistics[key] !== undefined) {
                                grid.innerHTML += '<div class="matching-item"><span class="label">' + label + '</span><span class="value">' + s.matching_statistics[key] + '</span></div>';
                            }
                        }
                        document.getElementById('matchingStats').style.display = 'block';
                    }

                    showAlert('process', 'Text extraction complete! ' + (s.articles_with_pdf||0) + ' PDFs processed.', 'success');
                    processBtn.disabled = false;
                } else if (s.status === 'error') {
                    showAlert('process', s.message, 'error');
                    hide('processProgress');
                    processBtn.disabled = false;
                } else {
                    setTimeout(pollProcessStatus, 1000);
                }
            } catch (err) {
                showAlert('process', 'Polling error: ' + err.message, 'error');
                hide('processProgress');
                processBtn.disabled = false;
            }
        }

        document.getElementById('downloadResultBtn').addEventListener('click', () => {
            if (processJobId) window.open(API_BASE + '/process/download/' + processJobId, '_blank');
        });

        document.getElementById('newProcessBtn').addEventListener('click', () => {
            hide('processResults'); hide('processProgress'); hideAlert('process');
            document.getElementById('matchingStats').style.display = 'none';
            uploadedPdfs = [];
            uploadedJson = null;
            pdfInput.value = '';
            jsonInput.value = '';
            document.getElementById('pdfUploadArea').classList.remove('has-files');
            document.getElementById('pdfFileList').innerHTML = '';
            document.getElementById('jsonUploadArea').classList.remove('has-files');
            document.getElementById('jsonFileName').style.display = 'none';
            processBtn.disabled = true;
            processJobId = null;
        });

        // ============================================================
        // HELPERS
        // ============================================================
        function show(id) { document.getElementById(id).classList.add('active'); }
        function hide(id) { document.getElementById(id).classList.remove('active'); }

        function showAlert(tab, msg, type) {
            const el = document.getElementById(tab + 'Alert');
            document.getElementById(tab + 'AlertMsg').textContent = msg;
            el.className = 'alert active alert-' + type;
        }

        function hideAlert(tab) {
            document.getElementById(tab + 'Alert').classList.remove('active');
        }

        function updateProgress(tab, percent, status, message) {
            document.getElementById(tab + 'ProgressBar').style.width = percent + '%';
            document.getElementById(tab + 'ProgressPercent').textContent = Math.round(percent) + '%';
            document.getElementById(tab + 'ProgressStatus').textContent = status;
            document.getElementById(tab + 'ProgressMsg').textContent = message;
        }

        function formatSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / 1048576).toFixed(1) + ' MB';
        }

    })();
    </script>
</body>
</html>